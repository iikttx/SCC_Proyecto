<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administración</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://kit.fontawesome.com/fb26bea93f.js" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      padding-top: 56px;
      display: flex;
      flex-direction: row;
    }

    #sidebar {
      width: 250px;
      height: calc(100vh - 56px);
      position: fixed;
      top: 56px;
      left: 0;
      background: #8c3031;
      color: white;
      padding-top: 1rem;
      display: none;
      overflow-y: auto;
      z-index: 1030;
    }

    #sidebar a {
      color: white;
      text-decoration: none;
      padding: 0.75rem 1rem;
      display: block;
    }

    #sidebar a:hover {
      background: #a94442;
      color: white;
    }

    @media (min-width: 768px) {
      #sidebar {
        display: block;
      }

      #content {
        margin-left: 250px;
      }

      #offcanvasToggle {
        display: none;
      }
    }

    .content {
      flex-grow: 1;
      padding: 1.5rem;
      margin-left: 0;
    }

    @media (min-width: 768px) {
      .content {
        margin-left: 250px;
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans overflow-x-hidden">


  <!-- Layout que se inserta dinámicamente -->
  <div id="layout-placeholder"></div>

  <!-- Contenido principal -->
  <div class="content container mt-4" id="content">
    <main class="flex-1 p-8 overflow-auto">
     <!--  <header class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold">Lista de Participantes</h1>
        <div class="flex items-center space-x-2">
          <img src="Fotito.jpg" alt="Foto de perfil" width="40" height="40">
        </div>
      </header> -->
      <h1 class="mb-4"><i class="fa-solid fa-landmark"></i>  Préstamo</h1>
      <button onclick="cargarParticipantes()" class="mb-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
        Cargar Participantes
      </button>

      <div class="bg-white shadow rounded-lg overflow-x-auto">
        <table class="min-w-full  table-auto">
          <thead class="bg-red-600 text-white">
            <tr>
              <th class="text-center px-1 py-3">ID</th>
              <th class="text-center px-1 py-3">Nombre</th>
              <th class="text-center px-1 py-3">Paterno</th>
              <th class="text-center px-1 py-3">Materno</th>
              <th class="text-center px-1 py-3">Semestre</th>
              <th class="text-center px-1 py-3">Rol</th>
              <th class="text-center px-1 py-3">Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-usuarios" class="divide-y divide-gray-200">
            <!-- Se llena con JS -->
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Cargar layout desde archivo externo -->
  <script>
    fetch('/pages/layout.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('layout-placeholder').innerHTML = html;
      });
  </script>

  <!-- Script para cargar participantes -->
  <script>
  // === Verificar JWT al cargar la página ===
  document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("token");
    if (!token) {
      // No hay token -> redirige al login
      window.location.href = "/pages/login.html";
      return;
    }

    // Validar el token con el backend
    fetch("/api/log-usuarios/verify", {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`
      }
    })
      .then(res => {
        if (!res.ok) throw new Error("Token inválido");
        return res.json();
      })
      .then(data => {
        console.log("Usuario autenticado:", data);

        // Opcional: Control por rol (solo admin)
        if (data.rol !== "1") {
          alert("Acceso restringido. Solo administradores pueden entrar aquí.");
          window.location.href = "/pages/inicio.html";
        }
      })
      .catch(() => {
        window.location.href = "/pages/inicio.html";
      });
  });

  // === Función genérica para usar el token en los fetch ===
  function fetchConToken(url, options = {}) {
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "/pages/login.html";
      return;
    }

    return fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });
  }

  // === Cargar Participantes ===
  function cargarParticipantes() {
    fetchConToken("/api/log-usuarios/getUsuarios")
      .then(res => res.json())
      .then(data => {
        const tabla = document.getElementById("tabla-usuarios");
        tabla.innerHTML = "";

        data.forEach(usuario => {
          const fila = document.createElement("tr");

          let rolTexto = "";
          switch (usuario.rol) {
            case "1":
            case 1:
              rolTexto = "Administrador";
              break;
            case "2":
            case 2:
              rolTexto = "Docente";
              break;
            case "3":
            case 3:
              rolTexto = "Estudiante";
              break;
            default:
              rolTexto = "Desconocido";
          }

          fila.innerHTML = `
            <td class="px-1 py-3"><input class="bg-transparent text-center" value="${usuario.id}" readonly /></td>
            <td class="px-1 py-3"><input class="bg-transparent text-center" value="${usuario.nombre}" /></td>
            <td class="px-1 py-3"><input class="bg-transparent text-center" value="${usuario.apellido_paterno}" /></td>
            <td class="px-1 py-3"><input class="bg-transparent text-center" value="${usuario.apellido_materno}" /></td>
            <td class="px-1 py-3"><input class="bg-transparent text-center" value="${usuario.semestre}" readonly /></td>
            <td class="px-1 py-3"><input class="bg-transparent text-center" value="${rolTexto}" readonly /></td>
            <td class="px-1 py-3">
              <button onclick="editarUsuario('${usuario.id}')" class="text-blue-600 hover:underline"><i class="fa-solid fa-pencil"></i></button>
              <button onclick="eliminarUsuario('${usuario.id}')" class="text-red-600 hover:underline ml-4"><i class="fa-solid fa-trash"></i></button>
            </td>
          `;
          tabla.appendChild(fila);
        });
      })
      .catch(err => console.error("Error al cargar participantes:", err));
  }

  // === Eliminar Usuario ===
  function eliminarUsuario(id) {
    if (!confirm("¿Estás seguro de que deseas eliminar este usuario?")) return;
    fetchConToken(`/api/log-usuarios/getUsuarios/${id}`, { method: "DELETE" })
      .then(res => res.json())
      .then(() => {
        alert("Usuario eliminado");
        cargarParticipantes();
      });
  }

  // === Editar Usuario ===
  function editarUsuario(id) {
    const nombre = document.querySelector(`#nombre-${id}`)?.value;
    const rolTexto = document.querySelector(`#rol-${id}`)?.value;

    let rol = null;
    switch (rolTexto.toLowerCase()) {
      case "administrador": rol = "1"; break;
      case "docente": rol = "2"; break;
      case "estudiante": rol = "3"; break;
      default:
        alert("Rol inválido");
        return;
    }

    fetchConToken(`/api/log-usuarios/getUsuarios/${id}`, {
      method: "PUT",
      body: JSON.stringify({ nombre, rol })
    })
      .then(res => res.json())
      .then(() => {
        alert("Usuario actualizado");
        cargarParticipantes();
      });
  }
</script>

</body>
</html>
